/*
                             *******************
******************************* C SOURCE FILE ********************************
**                           *******************                            **
**                                                                          **
**  Project   : E100_LDC                                                    **
**  Filename  : Rte_AswBswLink.c                                            **
**  Version   : -.- (PCB : )                                                **
**  Date      : 2019.09.05                                                  **
**                                                                          **
******************************************************************************
**                                                                          **
**  (c) 2019 YOUNG HWA TECH Co., Ltd. All Rights Reserved                   **
**                                                                          **
**                       YOUNG HWA TECH Co., Ltd.                           **
******************************************************************************

VERSION HISTORY:
----------------

Version     : -.-
Date        : ----.--.--
Revised by  : Im, Hong Kyun
Description : Original version.

*/

#define RTE_ASWBSWLINK_C_SRC

/****************************************************************************/
/**                                                                        **/
/**                      MODULES USED                                      **/
/**                                                                        **/
/****************************************************************************/
#include "Rte_AswBswLink.h"

/* ASW */
#include "../ASW/u_ASW.h"

/* BSW */
#include "pwm_BSW.h"
#include "../BSW/saradc_BSW.h"
#include "../BSW/u_BSW.h"
#include "../BSW/flexcan_BSW.h"

#include "../HAL/spc570_hal_adc.h"
#include "../HAL/spc570_hal_pwm.h"
#include "Asw_EEPROM.h"

/****************************************************************************/
/**                                                                        **/
/**                      DEFINITIONS AND MACROS                            **/
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                      TYPEDEFS AND STRUCTURES                           **/
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                      PROTOTYPES OF LOCAL FUNCTIONS                     **/
/**                                                                        **/
/****************************************************************************/
static void RTE_PWM_OFF_BY_IGN( void );

/****************************************************************************/
/**                                                                        **/
/**                      EXPORTED VARIABLES                                **/
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                      GLOBAL VARIABLES                                  **/
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/**                      EXPORTED FUNCTIONS                                **/
/**                                                                        **/
/****************************************************************************/
/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_BSW_Init( void )
{
	componentsInit();

	spc570_hal_pit_Init();

	BSW_PSFB_Init();

	/* Initializing of ADC module. */
	BSW_SARADC_Init();

	BSW_FlexCan_Init(); /* VECTOR */

	Gp_Func_Init();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_ASW_Init( void )
{
	ASW_LDC_INIT();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_ASW_PI_CTRL_Init( void )
{
	ASW_PI_CTRL_INIT();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_IGN_OFF( void )
{
	RTE_PWM_OFF_BY_IGN();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
uint8_t RTE_TASK_LDC_READY_CHECK( void )
{
	uint8_t rtnVal = yFALSE;

	BSW_UpdateADCValues(); /* update ADC sampling data */
	RTE_UPDATE_CAN_RX(); /* Checking CAN Rx message */

	if( ASW_LDC_READY_CHECK() == yTRUE )
	{
		RTE_SET_LDC_MODE_STATUS( LDC_MODE_NORMAL );
		rtnVal = yTRUE;
	}

	return rtnVal;
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_TASK_1ms( void )
{
	uint16_t psfbShiftVal = 0;
	uint32_t ldcPowerLatchCnt = RTE_GET_POWER_LATCH_COUNTER_VAL();

	BSW_UpdateADCValues(); /* update ADC sampling data */
	RTE_UPDATE_CAN_RX(); /* Checking CAN Rx message */

	if( ldcPowerLatchCnt > PWR_LATCH_PERIOD )
	{
		if( RTE_SOFT_STOP( RTE_GET_PHASE_SHIFT_VAL() ) == 1U )
		{
			RTE_ASW_PI_CTRL_Init();
		}
	}
	else
	{
		ASW_TASK_1MS();
		ASW_TASK_Operation();

		psfbShiftVal = RTE_GET_PHASE_SHIFT_VAL();
		SET_PSFB_VALUE( psfbShiftVal );
	}
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_TASK_10ms( void )
{
	RTE_CAN_IL_TASK ();
	RTE_CAN_Diag_TASK ();
	RTE_BattLvl_Check ();
	CAN_ReleasTx ();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_TASK_100ms( void )
{
	ASW_TASK_100MS();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_PSFB_SET_SR_OUTPUT_Ctrl( void )
{
	static uint16_t u16s_SrTurnOn_cnt = 0U;
	uint16_t outCurr = rteAdcRealResult.realOutputCurrent;

	if( u16g_StartSrOn_cnt >= 2000U )
	{
		if( outCurr > 100U ) /* 10A 이상에서만 turn on */
		{
			if( u16s_SrTurnOn_cnt >= 500U ){ BSW_PSFB_OUTPUT_SR_ENABLE(); }
			else{ u16s_SrTurnOn_cnt++; }
		}
		else
		{
			if( outCurr < 80U )
			{
				u16s_SrTurnOn_cnt = 0U;
				BSW_PSFB_OUTPUT_SR_DISABLE();
			}
		}
	}
	else
	{
		u16g_StartSrOn_cnt++;
	}
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_CHECK_POWER_LATCH( void )
{
#if ( POWER_LATCH_ON )
	power_latch();
#endif
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_PSFB_OUTPUT_DISABLE( void )
{
	BSW_PSFB_OUTPUT_DISABLE();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_PSFB_OUTPUT_SR_DISABLE( void )
{
	BSW_PSFB_OUTPUT_SR_DISABLE();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
void RTE_PSFB_OUTPUT_ENABLE( void )
{
	BSW_PSFB_OUTPUT_ENABLE();
}

/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
uint8_t RTE_PEAK_CURR_ERR_STATUS( void )
{
	return ( uint8_t )pal_readpad( PORT_A, HW_FAULT_DECTECTED_PIN );
}

/****************************************************************************/
/**                                                                        **/
/**                      LOCAL FUNCTIONS                                   **/
/**                                                                        **/
/****************************************************************************/
/*--------------------------------------------------------------------------*/
/* Function  |                                                              */
/* Name      |                                                              */
/*--------------------------------------------------------------------------*/
/* Parameter | Nothing                                                      */
/* Return    | Nothing                                                      */
/*--------------------------------------------------------------------------*/
static void RTE_PWM_OFF_BY_IGN( void )
{
	BSW_PSFB_OUTPUT_SR_DISABLE();
	BSW_PSFB_OUTPUT_DISABLE();
}

/****************************************************************************/
/**                                                                        **/
/**                      EOF                                               **/
/**                                                                        **/
/****************************************************************************/
